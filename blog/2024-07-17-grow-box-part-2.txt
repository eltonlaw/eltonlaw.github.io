2:I[5613,[],""]
3:I[1778,[],""]
4:I[5250,["250","static/chunks/250-92aea3426083640b.js","404","static/chunks/app/blog/page-3b1d09e20916cf9b.js"],""]
0:["DVXerpLq5cqBwuO_WOXGL",[[["",{"children":["blog",{"children":["2024-07-17-grow-box-part-2",{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":["2024-07-17-grow-box-part-2",{"children":["__PAGE__",{},["$L1",[["$","div",null,{"className":"postFrontmatter","children":[["$","h2",null,{"className":"PostFrontmatter_postTitle__fY2bg","children":"Building a Grow Box Part 2 - Startup"}],["$","span",null,{"className":"PostFrontmatter_postDate__ncWjv","children":"2024-07-19 11:44PM"}]]}],"\n",["$","h2",null,{"children":"linker_script.ld"}],"\n",["$","p",null,{"children":[["$","a",null,{"href":"https://github.com/eltonlaw/grow_box/blob/ae2f98f6b05255ffc7b34f53357f5c7018cad453/linker_script.ld","children":["$","code",null,{"children":"linker_script.ld"}]}]," is passed to ",["$","code",null,{"children":"arm-none-eabi-gcc"}]," via ",["$","code",null,{"children":"-Tlinker_script.ld"}]," and it defines the memory layout and section placement during program execution."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"ENTRY(Reset_Handler)\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":"Reset_Handler"}]," will be executed right after power-on."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"_estack = ORIGIN(RAM) + LENGTH(RAM);\n"}]}],"\n",["$","p",null,{"children":["The stack starts at the highest address and decrements, ",["$","code",null,{"children":"_estack"}]," will be the initialization value of the stack pointer."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"MEMORY\n{\n  RAM    (xrw)    : ORIGIN = 0x20000000,   LENGTH = 36K\n  FLASH    (rx)    : ORIGIN = 0x8000000,   LENGTH = 128K\n}\n"}]}],"\n",["$","p",null,{"children":"These values are just taken from the datasheet of the processor."}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"SECTIONS\n{\n...\n}\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":"SECTIONS"}]," are where what type of data goes into which memory region."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  .isr_vector :\n  {\n    . = ALIGN(4);\n    KEEP(*(.isr_vector)) /* Startup code */\n    . = ALIGN(4);\n  } >FLASH\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":">FLASH"}]," specifies that the section should be placed in the FLASH memory region. ",["$","code",null,{"children":"isr_vector"}]," contains the interrupt vector table and is placed at ",["$","code",null,{"children":"0x00000000"}]," in flash memory. When booting from flash, the microcontroller will be looking at that address. ",["$","code",null,{"children":"isr_vector"}]," is an array of 32-bit pointers to functions, the index of the pointer corresponds to a specific interrupt. The first 15 are common to all ARM processors ",["$","a",null,{"href":"https://developer.arm.com/documentation/107706/0100/Exceptions-and-interrupts-overview/Exception-types","children":"and defined by ARM here"}],", (keep in mind that lower priority numbers take priority over higher priority numbers). Any interrupts after that are either ST defined or custom."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  .text :\n  {\n    . = ALIGN(4);\n    *(.text)           /* .text sections (code) */\n    *(.text*)          /* .text* sections (code) */\n    *(.glue_7)         /* glue arm to thumb code */\n    *(.glue_7t)        /* glue thumb to arm code */\n    *(.eh_frame)\n\n    KEEP (*(.init))\n    KEEP (*(.fini))\n\n    . = ALIGN(4);\n    _etext = .;        /* define a global symbols at end of code */\n  } >FLASH\n"}]}],"\n",["$","p",null,{"children":"Right after the vector table is where we put the code sections"}],"\n",["$","p",null,{"children":"After that there are a few more sections I'm not going to go into:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":[["$","code",null,{"children":".rodata"}],": Read only data like constants and string literals"]}],"\n",["$","li",null,{"children":["$","code",null,{"children":".ARM.extab"}]}],"\n",["$","li",null,{"children":["$","code",null,{"children":".ARM"}]}],"\n",["$","li",null,{"children":["$","code",null,{"children":".preinit_array"}]}],"\n",["$","li",null,{"children":["$","code",null,{"children":".init_array"}]}],"\n",["$","li",null,{"children":["$","code",null,{"children":".fini_array"}]}],"\n"]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  .data :\n  {\n    . = ALIGN(4);\n    _sdata = .;\n    *(.data)\n    *(.data*)\n    *(.RamFunc)\n    *(.RamFunc*)\n\n    . = ALIGN(4);\n    _edata = .;\n\n  } >RAM AT> FLASH\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":">RAM AT> FLASH"}]," tells the linker to copy all of this from FLASH memory at startup. ",["$","code",null,{"children":".data"}]," is non-zero initialized data. Global symbols ",["$","code",null,{"children":"_sdata"}]," and ",["$","code",null,{"children":"_edata"}]," are created to mark the start and end of this section. These symbols will be used by the startup code in ",["$","code",null,{"children":"Reset_Handler"}],". The ",["$","code",null,{"children":".RamFunc"}]," sections are special code that is going to be executed from RAM rather than FLASH."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  .bss :\n  {\n    /* This is used by the startup in order to initialize the .bss section */\n    _sbss = .;         /* define a global symbol at bss start */\n    __bss_start__ = _sbss;\n    *(.bss)\n    *(.bss*)\n    *(COMMON)\n\n    . = ALIGN(4);\n    _ebss = .;         /* define a global symbol at bss end */\n    __bss_end__ = _ebss;\n  } >RAM\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":".bss"}]," is all zero initialized and uninitialized data, Global symbols ",["$","code",null,{"children":"_sbss"}]," and ",["$","code",null,{"children":"_ebss"}]," are created to mark the start and end of this section and on init we can just fill from start to end with zeros."]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  ._user_heap_stack :\n  {\n    . = ALIGN(8);\n    PROVIDE ( end = . );\n    PROVIDE ( _end = . );\n    . = . + _Min_Heap_Size;\n    . = . + _Min_Stack_Size;\n    . = ALIGN(8);\n  } >RAM\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":".user_heap_stack"}]," is the last section in RAM, since the heap grows up to meet the stack growing down to maximize utilization."]}],"\n",["$","h2",null,{"children":"Startup Code"}],"\n",["$","p",null,{"children":[["$","a",null,{"href":"https://github.com/eltonlaw/grow_box/blob/ae2f98f6b05255ffc7b34f53357f5c7018cad453/src/startup_stm32g070xx.s","children":["$","code",null,{"children":"startup_stm32g070xx.s"}]}]," contains the code to run the setup necessary to execute the application ",["$","code",null,{"children":"main"}],". The first lines are assembler directives."]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".syntax unified\n"}]}],"\n",["$","p",null,{"children":["Use ",["$","a",null,{"href":"https://sourceware.org/binutils/docs/as/ARM_002dInstruction_002dSet.html#ARM_002dInstruction_002dSet","children":"unified instruction set syntax"}]," for ",["$","code",null,{"children":"ARM"}]," and ",["$","code",null,{"children":"THUMB"}]," instructions."]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".cpu cortex-m0plus\n"}]}],"\n",["$","p",null,{"children":["Select the processor core. This is equivalent to hardcoding the ",["$","code",null,{"children":"-mcpu"}]," CLI option. This determines the available instructions and features that the compiler can use."]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".fpu softvfp\n"}]}],"\n",["$","p",null,{"children":"Cortex M0+ does not have a hardware floating point unit so we tell the assembler that floating point ops need to be emulated using integer instructions and to use general purpose registers to store arguments and return values. There is a standard floating-point instruction set and this allows us to keep using those instructions at the cost of slower execution."}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".thumb\n"}]}],"\n",["$","p",null,{"children":"There are two 32 bit instruction sets ARM (A32) and Thumb (T32). ARM instructions are always 32-bit whereas thumb instructions includes both 16-bit and 32-bit instructions. ARMv6-M only supports Thumb instructions. This tells the assembler that all subsequent instructions should be read as T32 instructions."}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".global g_pfnVectors\n.global Default_Handler\n"}]}],"\n",["$","p",null,{"children":["Two globally visible symbols are declared ",["$","code",null,{"children":"g_pfnVectors"}]," and ",["$","code",null,{"children":"Default_Handler"}],". ",["$","code",null,{"children":"g_pfnVectors"}]," for a global array of pointers to functions/function pointers to be used by the interrupt handler to lookup the correct function to call based on the interrupt triggered. ",["$","code",null,{"children":"Default_Handler"}]," is the fallback function when there's no function found for that interrupt type."]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":".word _sidata\n.word _sdata\n.word _edata\n.word _sbss\n.word _ebss\n"}]}],"\n",["$","p",null,{"children":["Allocate and initialize space for the 5 addresses marking start/end of sections, to be used by ",["$","code",null,{"children":"Reset_Handler"}]," during runtime initialization."]}],"\n",["$","h3",null,{"children":"Reset Handler"}],"\n",["$","p",null,{"children":[["$","code",null,{"children":"Reset_Handler"}]," is what gets called when the device powers up, from page 51 of the ",["$","a",null,{"href":"https://www.st.com/resource/en/reference_manual/rm0454-stm32g0x0-advanced-armbased-32bit-mcus-stmicroelectronics.pdf","children":"reference manual"}]]}],"\n",["$","blockquote",null,{"children":["\n",["$","p",null,{"children":"...After this startup delay has elapsed, the CPU fetches the top-of-stack value from address 0x0000 0000, then starts code execution from the boot memory at 0x0000 0004."}],"\n"]}],"\n",["$","p",null,{"children":["The vector table is placed at ",["$","code",null,{"children":"0x0000 0000"}]," (of flash memory) and the pointer to the reset handler is set at index 1"]}],"\n",["$","pre",null,{"children":["$","code",null,{"children":"  ...\n  .section .isr_vector,\"a\",%progbits\n  .type g_pfnVectors, %object\n\ng_pfnVectors:\n  .word _estack\n  .word Reset_Handler\n  .word NMI_Handler\n  ...\n"}]}],"\n",["$","p",null,{"children":["Here's ",["$","code",null,{"children":"Reset_Handler"}]]}],"\n",["$","pre",null,{"children":["$","code",null,{"className":"hljs language-armasm","children":"  .section .text.Reset_Handler\n  .weak Reset_Handler\n  .type Reset_Handler, %function\nReset_Handler:\n  ldr   r0, =_estack\n  mov   sp, r0          /* set stack pointer */\n\n/* Call the clock system initialization function.*/\n  bl  SystemInit\n\n/* Copy the data segment initializers from flash to SRAM */\n  ldr r0, =_sdata\n  ldr r1, =_edata\n  ldr r2, =_sidata\n  movs r3, #0\n  b LoopCopyDataInit\n\nCopyDataInit:\n  ldr r4, [r2, r3]\n  str r4, [r0, r3]\n  adds r3, r3, #4\n\nLoopCopyDataInit:\n  adds r4, r0, r3\n  cmp r4, r1\n  bcc CopyDataInit\n\n/* Zero fill the bss segment. */\n  ldr r2, =_sbss\n  ldr r4, =_ebss\n  movs r3, #0\n  b LoopFillZerobss\n\nFillZerobss:\n  str  r3, [r2]\n  adds r2, r2, #4\n\nLoopFillZerobss:\n  cmp r2, r4\n  bcc FillZerobss\n"}]}],"\n",["$","p",null,{"children":[["$","code",null,{"children":"Reset_Handler"}]," does the following:"]}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["Set the top of the stack with the value of the global symbol ",["$","code",null,{"children":"_estack"}]," created by the linker, as the stack pointer"]}],"\n",["$","li",null,{"children":["Call ",["$","code",null,{"children":"SystemInit"}],", which is a vendor-defined no-op currently"]}],"\n",["$","li",null,{"children":["Call ",["$","code",null,{"children":"LoopCopyDataInit"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":["Calls ",["$","code",null,{"children":"LoopCopyDataInit"}]," which loads each value of the data segment from ",["$","code",null,{"children":"_sdata"}]," to ",["$","code",null,{"children":"_edata"}]," in flash and stores it in RAM."]}],"\n",["$","li",null,{"children":["Calls ",["$","code",null,{"children":"LoopFillZerobss"}]," stores 0 at every address from ",["$","code",null,{"children":"_sbss"}]," (start of BSS) to ",["$","code",null,{"children":"_ebss"}]," (end of BSS)"]}],"\n"]}],"\n"]}],"\n",["$","li",null,{"children":[["$","code",null,{"children":"LoopFillZerobss"}]," calls C runtime library init ",["$","code",null,{"children":"__libc_init_array"}]," and then calls ",["$","code",null,{"children":"main"}]]}],"\n"]}]],null]]},["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","2024-07-17-grow-box-part-2","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/bd17e4652862e3d3.css","precedence":"next","crossOrigin":""}]]}]]},["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},[null,["$","html",null,{"lang":"en","children":["$","body",null,{"children":["$","div",null,{"className":"RootLayout_container__tH3RP","children":[["$","div",null,{"className":"RootLayout_masthead__LsRd7","children":[["$","h3",null,{"className":"$undefined","children":[["$","$L4",null,{"className":"RootLayout_titleLink__VQPJ9","href":"/","children":"eltonlaw"}],["$","small",null,{"children":" sundries"}]]}],["$","$L4",null,{"className":"RootLayout_titleLink__VQPJ9","href":"https://github.com/eltonlaw","children":["$","svg",null,{"viewBox":"0 0 16 16","width":"16px","height":"16px","children":["$","path",null,{"fill":"#828282","d":"M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"}]}]}]]}],["$","$L2",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":null}]]}]}]}],null]],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5d82fb85d7740057.css","precedence":"next","crossOrigin":""}]],"$L5"]]]]
5:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"eltonlaw"}]]
1:null
