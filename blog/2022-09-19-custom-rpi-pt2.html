<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/c85e7b0be5854569.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/bd17e4652862e3d3.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-97b8a957c769ed78.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-735d320b4b8745cb.js" async="" crossorigin=""></script><script src="/_next/static/chunks/938-cd2116519108597b.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-52a4d49535073763.js" async="" crossorigin=""></script><script src="/_next/static/chunks/250-e6a6f086b85a6178.js" async=""></script><script src="/_next/static/chunks/app/blog/page-de834b81a5f504c7.js" async=""></script><title>eltonlaw</title><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><div class="RootLayout_container__tH3RP"><div class="RootLayout_masthead__LsRd7"><h3><a class="RootLayout_titleLink__VQPJ9" href="/">eltonlaw</a><small> sundries</small></h3><a class="RootLayout_titleLink__VQPJ9" href="https://github.com/eltonlaw"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg></a></div><div class="postFrontmatter"><h2 class="PostFrontmatter_postTitle__fY2bg">Building A Custom Raspberry Pi Image - pt. 2</h2><span class="PostFrontmatter_postDate__ncWjv">2022-09-19 8:13PM</span></div>
<h4>Updating buildroot to latest stable</h4>
<p>Updating the buildroot submodule led to some issues with legacy options in my <code>.config</code>.</p>
<p>I had taken a patch that wasn&#x27;t merged into master, adding missing dependencies <code>host-libjpeg</code> and <code>host-freetype</code> to <code>QT5WEBENGINE_DEPENDENCIES</code> in <code>package/qt5/qt5webengine/qt5webengine.mk</code>. That&#x27;s in there now, so I can remove the <code>git apply</code> hotfix stuff I had.</p>
<p>The following is deprecated and was moved into a separate package</p>
<pre><code>BR2_PACKAGE_RPI_WIFI_FIRMWARE=y
</code></pre>
<p>The Raspberry Pi 3B has a Broadcom BCM43438 chip (renamed to CYW43438) which has 2.4ghz WLAN and BT 5.1 The new entries should look like</p>
<pre><code>BR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI=y
BR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI_BT=y
BR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI_WIFI=y
</code></pre>
<h4>Split into development image and release image</h4>
<p>release image will have everything required to run the QT UI and the systemd services</p>
<p>development image will be release image with some extra debug tooling. Currently,</p>
<pre><code>BR2_CCACHE=y
BR2_ENABLE_DEBUG=y
BR2_ENABLE_RUNTIME_DEBUG=y
BR2_OPTIMIZE_G=y
</code></pre>
<h4>Switching the init system to systemd</h4>
<p>From the default of busybox, I decided to switch to systemd as the init system. Busybox was easy to work with but I&#x27;m planning to have a lot of services; polling of various sensors, cloud backup, real time data analysis, etc. Maybe 10 - 20 different processes running concurrently, with some sort of IPC between them. Bringing in systemd increases the image size and complexity of the codebase but will standardize alot of the integration I think. For IPC I was planning to use DBus too, so it would fit well.</p>
<p>For certain services, <a href="http://0pointer.de/blog/projects/socket-activation.html">socket activation</a> allows for very, very fast starts. Basically, all services can be started in parallel if the sockets they output data to are initialized first before any services that consume from them are started. Then any service can start and it&#x27;ll just start queuing messages which sit there. The destination service will spin up in time and start processing the backlog. I&#x27;m planning to make all the sensor services point to a socket, it would be interesting to see how much lag time there is between pressing the power button and the first sensor measurement.
Changing it involves just adding</p>
<pre><code>BR2_INIT_SYSTEMD=y
BR2_PACKAGE_SYSTEMD=y
</code></pre>
<h4>QT can&#x27;t connect to the D-Bus session bus.</h4>
<p>Added a connect to QT session bus in the UI. Got an error</p>
<pre><code>&quot;Cannot connect to the D-Bus session bus&quot;
</code></pre>
<p>Which is because QT can&#x27;t determine the unix path of the D-BUS session bus socket filepath. This is fixable by running</p>
<pre><code>export $(dbus-launch)
</code></pre>
<p>and that just exports <code>DBUS_SESSION_BUS_ADDRESS</code> and <code>DBUS_SESSION_BUS_PID</code>.</p></div><script src="/_next/static/chunks/webpack-97b8a957c769ed78.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/c85e7b0be5854569.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/bd17e4652862e3d3.css\",\"style\",{\"crossOrigin\":\"\"}]\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n6:I[5613,[],\"\"]\n7:I[1778,[],\"\"]\n8:I[5250,[\"250\",\"static/chunks/250-e6a6f086b85a6178.js\",\"404\",\"static/chunks/app/blog/page-de834b81a5f504c7.js\"],\"\"]\na:I[8955,[],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c85e7b0be5854569.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"i7SLSU24vT1nhdnVxdcbs\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/2022-09-19-custom-rpi-pt2\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[\"2022-09-19-custom-rpi-pt2\",{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[\"2022-09-19-custom-rpi-pt2\",{\"children\":[\"__PAGE__\",{},[\"$L5\",[[\"$\",\"div\",null,{\"className\":\"postFrontmatter\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"PostFrontmatter_postTitle__fY2bg\",\"children\":\"Building A Custom Raspberry Pi Image - pt. 2\"}],[\"$\",\"span\",null,{\"className\":\"PostFrontmatter_postDate__ncWjv\",\"children\":\"2022-09-19 8:13PM\"}]]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Updating buildroot to latest stable\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Updating the buildroot submodule led to some issues with legacy options in my \",[\"$\",\"code\",null,{\"children\":\".config\"}],\".\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"I had taken a patch that wasn't merged into master, adding missing dependencies \",[\"$\",\"code\",null,{\"children\":\"host-libjpeg\"}],\" and \",[\"$\",\"code\",null,{\"children\":\"host-freetype\"}],\" to \",[\"$\",\"code\",null,{\"children\":\"QT5WEBENGINE_DEPENDENCIES\"}],\" in \",[\"$\",\"code\",null,{\"children\":\"package/qt5/qt5webengine/qt5webengine.mk\"}],\". That's in there now, so I can remove the \",[\"$\",\"code\",null,{\"children\":\"git apply\"}],\" hotfix stuff I had.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The following is deprecated and was moved into a separate package\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"BR2_PACKAGE_RPI_WIFI_FIRMWARE=y\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The Raspberry Pi 3B has a Broadcom BCM43438 chip (renamed to CYW43438) which has 2.4ghz WLAN and BT 5.1 The new entries should look like\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"BR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI=y\\nBR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI_BT=y\\nBR2_PACKAGE_BRCMFMAC_SDIO_FIRMWARE_RPI_WIFI=y\\n\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Split into development image and release image\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"release image will have everything required to run the QT UI and the systemd services\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"development image will be release image with some extra debug tooling. Currently,\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"BR2_CCACHE=y\\nBR2_ENABLE_DEBUG=y\\nBR2_ENABLE_RUNTIME_DEBUG=y\\nBR2_OPTIMIZE_G=y\\n\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"Switching the init system to systemd\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"From the default of busybox, I decided to switch to systemd as the init system. Busybox was easy to work with but I'm planning to have a lot of services; polling of various sensors, cloud backup, real time data analysis, etc. Maybe 10 - 20 different processes running concurrently, with some sort of IPC between them. Bringing in systemd increases the image size and complexity of the codebase but will standardize alot of the integration I think. For IPC I was planning to use DBus too, so it would fit well.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"For certain services, \",[\"$\",\"a\",null,{\"href\":\"http://0pointer.de/blog/projects/socket-activation.html\",\"children\":\"socket activation\"}],\" allows for very, very fast starts. Basically, all services can be started in parallel if the sockets they output data to are initialized first before any services that consume from them are started. Then any service can start and it'll just start queuing messages which sit there. The destination service will spin up in time and start processing the backlog. I'm planning to make all the sensor services point to a socket, it would be interesting to see how much lag time there is between pressing the power button and the first sensor measurement.\\nChanging it involves just adding\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"BR2_INIT_SYSTEMD=y\\nBR2_PACKAGE_SYSTEMD=y\\n\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"QT can't connect to the D-Bus session bus.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Added a connect to QT session bus in the UI. Got an error\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"\\\"Cannot connect to the D-Bus session bus\\\"\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Which is because QT can't determine the unix path of the D-BUS session bus socket filepath. This is fixable by running\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"export $(dbus-launch)\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"and that just exports \",[\"$\",\"code\",null,{\"children\":\"DBUS_SESSION_BUS_ADDRESS\"}],\" and \",[\"$\",\"code\",null,{\"children\":\"DBUS_SESSION_BUS_PID\"}],\".\"]}]],null]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"2022-09-19-custom-rpi-pt2\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/bd17e4652862e3d3.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]]}]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"RootLayout_container__tH3RP\",\"children\":[[\"$\",\"div\",null,{\"className\":\"RootLayout_masthead__LsRd7\",\"children\":[[\"$\",\"h3\",null,{\"className\":\"$undefined\",\"children\":[[\"$\",\"$L8\",null,{\"className\":\"RootLayout_titleLink__VQPJ9\",\"href\":\"/\",\"children\":\"eltonlaw\"}],[\"$\",\"small\",null,{\"children\":\" sundries\"}]]}],[\"$\",\"$L8\",null,{\"className\":\"RootLayout_titleLink__VQPJ9\",\"href\":\"https://github.com/eltonlaw\",\"children\":[\"$\",\"svg\",null,{\"viewBox\":\"0 0 16 16\",\"width\":\"16px\",\"height\":\"16px\",\"children\":[\"$\",\"path\",null,{\"fill\":\"#828282\",\"d\":\"M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z\"}]}]}]]}],[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]]}]}]}],null]],\"initialHead\":[false,\"$L9\"],\"globalErrorComponent\":\"$a\"}]]\n"])</script><script>self.__next_f.push([1,"9:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"eltonlaw\"}]]\n5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>