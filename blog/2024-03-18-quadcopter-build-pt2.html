<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/c85e7b0be5854569.css" crossorigin="" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/bd17e4652862e3d3.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-97b8a957c769ed78.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-735d320b4b8745cb.js" async="" crossorigin=""></script><script src="/_next/static/chunks/938-cd2116519108597b.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-52a4d49535073763.js" async="" crossorigin=""></script><script src="/_next/static/chunks/250-e6a6f086b85a6178.js" async=""></script><script src="/_next/static/chunks/app/blog/page-de834b81a5f504c7.js" async=""></script><title>eltonlaw</title><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><div class="RootLayout_container__tH3RP"><div class="RootLayout_masthead__LsRd7"><h3><a class="RootLayout_titleLink__VQPJ9" href="/">eltonlaw</a><small> sundries</small></h3><a class="RootLayout_titleLink__VQPJ9" href="https://github.com/eltonlaw"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg></a></div><div class="postFrontmatter"><h2 class="PostFrontmatter_postTitle__fY2bg">Building a Quadcopter. Pt.2</h2><span class="PostFrontmatter_postDate__ncWjv">2024-03-18 1:36AM</span></div>
<p>The flight computer is a STM32G070RB, it has relatively low power consumption and enough communication interfaces to connect an IMU, GPS and 4 ESCs so I think it should work fine for V1. I&#x27;m going to use the ST provided HAL anyways and all the chips share roughly the same abstractions so upsizing it shouldn&#x27;t be too much work in the future. I&#x27;m developing with a <a href="https://www.st.com/en/evaluation-tools/nucleo-g070rb.html">NUCLEO board</a> which has built-in power management and exposes the I/O pins which would have been some necessary work otherwise, building a breakout board. There&#x27;s also a USB STLINK component on the board which makes flashing dead simple. When I set up a project through STM32CubeIDE and configured the target it was able to build and flash a hello world right out of the box.</p>
<p>The IMU I have hooked up is the MPU6050, which is old and not manufactured anymore. Will upgrade to the ICM20948 in the future but for now this works, the board seems pretty ubiquitous, so setting it up wasn&#x27;t too difficult. Initialization covers a few things:</p>
<ol>
<li>Configure I2C peripheral 1 on the flight computer for 400KHz. I noticed there would be issues doing I2C operations every few flashes, regardless of code changes and found out that the <code>static void MX_I2C1_Init(void)</code> generated by the STM32CubeIDE for initializing the peripheral needed some delay after running. I&#x27;m not sure why this happens since it seems like the calls to <code>HAL_I2C_Init(...)</code>, <code>HAL_I2CEx_ConfigAnalaogFilter(...)</code> and  <code>HAL_I2CEx_ConfigDigitalFilter(...)</code> all check for <code>HAL_OK</code> before returning. I expected it to be ready to use right away. Initialzing the MPU6050 so it retries up to 5 times with delay before panicing resolved the issue. The behaviour I&#x27;m most often now is it&#x27;ll fail once to read from the bus before succeeding on the second loop. Planning to revisit this to see if there&#x27;s some I2C configuration error I&#x27;ve done.</li>
<li>Read the <code>WHO_AM_I</code> register (0x75) and check that <code>0x68</code> is being returned, this is a nice simple check for verifying physical connections and message formatting are correct.</li>
<li><code>PWR_MGMT_1</code> register (0x6C) bit 6 needs to be cleared to disable sleep mode, by default its set.</li>
<li>The accelerometer precision is set via <code>ACCEL_CONFIG</code> (0x1C) bits [4:3]. The MPU6050 is a MEMS sensor that measures differences in capacitance of electrodes on a microscopic spring (capacitive sensing), one for each direction XYZ. From the outside that corresponds to a voltage difference which can be interpreted differently depending on how precise the measurement needs to be. The full voltage range is split into 16 bits and you could bucket that between +- 2/4/8/16 G&#x27;s of force.</li>
<li>Similar to the accelerometer, gyroscope precision is set via <code>GYRO_CONFIG</code> (0x1B) bits [4:3] and has a similar set of 3 sensors that exploits the Coriolis effect for XYZ. The full voltage range is split again into 16 bits and depending on precision you can choose between +- 250/500/1000/2000 degrees per second.</li>
<li>Offset calibration: The sensors aren&#x27;t perfect for whatever reason (components, manufacturing etc.) and when perfectly still the accelerometer and gyroscope should output (0G, 0G, 1G) and (0 DPS, 0 DPS, 0 DPS) respectively. I&#x27;m making it take 700 readings (at rest) and averaging that to calculate a number to subtract when in use. NOTE: The Z access for the accelerometer should be 1G for Earth&#x27;s gravity at ground level, might be worth it one day to be smarter about that based on elevation, but going to just use that for now.</li>
</ol></div><script src="/_next/static/chunks/webpack-97b8a957c769ed78.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/c85e7b0be5854569.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/bd17e4652862e3d3.css\",\"style\",{\"crossOrigin\":\"\"}]\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n6:I[5613,[],\"\"]\n7:I[1778,[],\"\"]\n8:I[5250,[\"250\",\"static/chunks/250-e6a6f086b85a6178.js\",\"404\",\"static/chunks/app/blog/page-de834b81a5f504c7.js\"],\"\"]\na:I[8955,[],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c85e7b0be5854569.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"lNtzQe4zncAoL4_yMx38u\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/2024-03-18-quadcopter-build-pt2\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[\"2024-03-18-quadcopter-build-pt2\",{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[\"2024-03-18-quadcopter-build-pt2\",{\"children\":[\"__PAGE__\",{},[\"$L5\",[[\"$\",\"div\",null,{\"className\":\"postFrontmatter\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"PostFrontmatter_postTitle__fY2bg\",\"children\":\"Building a Quadcopter. Pt.2\"}],[\"$\",\"span\",null,{\"className\":\"PostFrontmatter_postDate__ncWjv\",\"children\":\"2024-03-18 1:36AM\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The flight computer is a STM32G070RB, it has relatively low power consumption and enough communication interfaces to connect an IMU, GPS and 4 ESCs so I think it should work fine for V1. I'm going to use the ST provided HAL anyways and all the chips share roughly the same abstractions so upsizing it shouldn't be too much work in the future. I'm developing with a \",[\"$\",\"a\",null,{\"href\":\"https://www.st.com/en/evaluation-tools/nucleo-g070rb.html\",\"children\":\"NUCLEO board\"}],\" which has built-in power management and exposes the I/O pins which would have been some necessary work otherwise, building a breakout board. There's also a USB STLINK component on the board which makes flashing dead simple. When I set up a project through STM32CubeIDE and configured the target it was able to build and flash a hello world right out of the box.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The IMU I have hooked up is the MPU6050, which is old and not manufactured anymore. Will upgrade to the ICM20948 in the future but for now this works, the board seems pretty ubiquitous, so setting it up wasn't too difficult. Initialization covers a few things:\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Configure I2C peripheral 1 on the flight computer for 400KHz. I noticed there would be issues doing I2C operations every few flashes, regardless of code changes and found out that the \",[\"$\",\"code\",null,{\"children\":\"static void MX_I2C1_Init(void)\"}],\" generated by the STM32CubeIDE for initializing the peripheral needed some delay after running. I'm not sure why this happens since it seems like the calls to \",[\"$\",\"code\",null,{\"children\":\"HAL_I2C_Init(...)\"}],\", \",[\"$\",\"code\",null,{\"children\":\"HAL_I2CEx_ConfigAnalaogFilter(...)\"}],\" and  \",[\"$\",\"code\",null,{\"children\":\"HAL_I2CEx_ConfigDigitalFilter(...)\"}],\" all check for \",[\"$\",\"code\",null,{\"children\":\"HAL_OK\"}],\" before returning. I expected it to be ready to use right away. Initialzing the MPU6050 so it retries up to 5 times with delay before panicing resolved the issue. The behaviour I'm most often now is it'll fail once to read from the bus before succeeding on the second loop. Planning to revisit this to see if there's some I2C configuration error I've done.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Read the \",[\"$\",\"code\",null,{\"children\":\"WHO_AM_I\"}],\" register (0x75) and check that \",[\"$\",\"code\",null,{\"children\":\"0x68\"}],\" is being returned, this is a nice simple check for verifying physical connections and message formatting are correct.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"PWR_MGMT_1\"}],\" register (0x6C) bit 6 needs to be cleared to disable sleep mode, by default its set.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"The accelerometer precision is set via \",[\"$\",\"code\",null,{\"children\":\"ACCEL_CONFIG\"}],\" (0x1C) bits [4:3]. The MPU6050 is a MEMS sensor that measures differences in capacitance of electrodes on a microscopic spring (capacitive sensing), one for each direction XYZ. From the outside that corresponds to a voltage difference which can be interpreted differently depending on how precise the measurement needs to be. The full voltage range is split into 16 bits and you could bucket that between +- 2/4/8/16 G's of force.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Similar to the accelerometer, gyroscope precision is set via \",[\"$\",\"code\",null,{\"children\":\"GYRO_CONFIG\"}],\" (0x1B) bits [4:3] and has a similar set of 3 sensors that exploits the Coriolis effect for XYZ. The full voltage range is split again into 16 bits and depending on precision you can choose between +- 250/500/1000/2000 degrees per second.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Offset calibration: The sensors aren't perfect for whatever reason (components, manufacturing etc.) and when perfectly still the accelerometer and gyroscope should output (0G, 0G, 1G) and (0 DPS, 0 DPS, 0 DPS) respectively. I'm making it take 700 readings (at rest) and averaging that to calculate a number to subtract when in use. NOTE: The Z access for the accelerometer should be 1G for Earth's gravity at ground level, might be worth it one day to be smarter about that based on elevation, but going to just use that for now.\"}],\"\\n\"]}]],null]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"2024-03-18-quadcopter-build-pt2\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/bd17e4652862e3d3.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]]}]]},[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"RootLayout_container__tH3RP\",\"children\":[[\"$\",\"div\",null,{\"className\":\"RootLayout_masthead__LsRd7\",\"children\":[[\"$\",\"h3\",null,{\"className\":\"$undefined\",\"children\":[[\"$\",\"$L8\",null,{\"className\":\"RootLayout_titleLink__VQPJ9\",\"href\":\"/\",\"children\":\"eltonlaw\"}],[\"$\",\"small\",null,{\"children\":\" sundries\"}]]}],[\"$\",\"$L8\",null,{\"className\":\"RootLayout_titleLink__VQPJ9\",\"href\":\"https://github.com/eltonlaw\",\"children\":[\"$\",\"svg\",null,{\"viewBox\":\"0 0 16 16\",\"width\":\"16px\",\"height\":\"16px\",\"children\":[\"$\",\"path\",null,{\"fill\":\"#828282\",\"d\":\"M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z\"}]}]}]]}],[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]]}]}]}],null]],\"initialHead\":[false,\"$L9\"],\"globalErrorComponent\":\"$a\"}]]\n"])</script><script>self.__next_f.push([1,"9:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"eltonlaw\"}]]\n5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>